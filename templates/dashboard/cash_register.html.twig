{% extends 'base.html.twig' %}

{% block title %}
  Contr√¥le de caisse
{% endblock %}

{% block content %}
  <h1>Gestion de la caisse</h1>

  {% if session %}
    <div class="sections-container three-sections">
      <section class="card">
        <p class="state-ok">
          Caisse ouverte par {{ session.openedBy.firstName }} le {{ session.openingAt|date('d/m/Y') }} √† {{ session.openingAt|date('H\\hi') }}
        </p>

        <div class="cash-summary">
          <p>‚Ä¢ Fond de caisse : {{ cash_float|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>‚Ä¢ Total des ventes pour la session en cours : {{ total_price|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>‚Ä¢ Total CB : {{ total_card|number_format(2, ',', ' ') }} ‚Ç¨</p>
          {# <p>Total esp√®ces : {{ (total_cash > 0 ? total_cash : 0)|number_format(2, ',', ' ') }} ‚Ç¨</p> #}
          <p>‚Ä¢ Total esp√®ces donn√©es : {{ total_cash|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>‚Ä¢ Total du retour monnaie : {{ returned_change|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>‚Ä¢ Total monnaie gard√©e : {{ total_keep_change|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>‚Ä¢ Total prix libres : {{ total_pwyw_amount|number_format(2, ',', ' ') }} ‚Ç¨</p>

          <div class="withdrawals-summary">
            <button type="button" class="toggle-details button-secondary mt-1" data-target="#opration-details">
              <i class="ph ph-eye"></i> Voir le d√©tail des op√©rations en esp√®ces
            </button>

            <div id="operation-details" class="hidden mt-1">
              {% if cash_movements is not empty %}
                <ul class="cash-movements-list">
                  {% for movement in cash_movements %}
                    <li class="cash-movement-item">
                      <p>
                        ‚ñ∫ {{ movement.type.getLabel() }} de {{ movement.amount|number_format(2, ',', ' ') }} ‚Ç¨ par {{
                          movement.madeBy.firstName
                        }} √† {{ movement.createdAt|date(' H\\hi') }}
                      </p>
                      {% if movement.comment %}
                        <p class="note">Commentaire : {{ movement.comment }}</p>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>Aucun ajout ou retrait effectu√©.</p>
              {% endif %}
            </div>
          </div>
        </div>
        <p class="bold">
          Solde th√©orique attendu dans la caisse : <span id="theoreticalBalance">
            {{ theoretical_balance|number_format(2, ',', ' ') }}
          </span> ‚Ç¨
        </p>
      </section>

      <section class="card withdrawal">
        <h2>Effectuer une op√©ration en esp√®ces</h2>
        {% include 'partials/flash.html.twig' %}

        {{ form_start(cash_movement_form) }}

        <div class="form-group">
          {{ form_label(cash_movement_form.type) }}

          {% for choice in cash_movement_form.type %}
            <div class="radio-option">
              {{ form_widget(choice) }}
              {{ form_label(choice) }}
            </div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form_label(cash_movement_form.amount) }}
          {{ form_widget(cash_movement_form.amount) }}
          {% for error in cash_movement_form.amount.vars.errors %}
            <p role="note" class="flash-error">{{ error.message }}</p>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form_label(cash_movement_form.comment) }}
          {{ form_widget(cash_movement_form.comment) }}
        </div>

        <button type="submit" class="button-primary">Valider l'op√©ration</button>

        {{ form_end(cash_movement_form) }}
      </section>

      <section class="card">
        <h2>Cl√¥ture de caisse</h2>
        {{ form_start(closure_form) }}
        <article class="balance-section">
          <div class="form-group">
            {{ form_label(closure_form.countedBalance) }}
            {{ form_widget(closure_form.countedBalance) }}
            {% for error in closure_form.countedBalance.vars.errors %}
              <p role="note" class="flash-error">{{ error.message }}</p>
            {% endfor %}
          </div>
        </article>

        <article class="comment-toggle-section">
          <div class="discrepancy-container">
            {{ form_label(closure_form.discrepancy) }}
            {{ form_widget(closure_form.discrepancy) }}
          </div>
          <button type="button" class="button-grey-shadow note-toggle mt-2">
            <i class="ph ph-receipt"></i> √âcrire un commentaire
          </button>

          <div class="form-group hidden mt-1">
            {{ form_label(closure_form.note) }}
            {{ form_widget(closure_form.note) }}
          </div>
        </article>

        <button type="submit" class="button-primary">Cl√¥turer la caisse</button>
        {{ form_end(closure_form) }}
      </section>
    </div>
  {% else %}
    {% if lastClosure %}
      <section class="card">
        <p class="alert">
          Derni√®re caisse ferm√©e par {{ lastClosure.closedByName|default('Inconnu') }}
          le {{ lastClosure.closedAt ? lastClosure.closedAt|date('d/m/Y') : 'Date inconnue' }}
          √† {{ lastClosure.closedAt ? lastClosure.closedAt|date('H\\hi') : '--h--' }}
        </p>
        <div>
          <p>
            Total des ventes pour cette session : {{ (lastClosure.totalSales ?? 0)|number_format(2, ',', ' ') }} ‚Ç¨ (dont
            {{ (lastClosure.totalPwyw ?? 0)|number_format(2, ',', ' ') }} ‚Ç¨ en prix libres).
          </p>
          <p>Total des montants par CB : {{ (lastClosure.totalCard ?? 0)|number_format(2, ',', ' ') }} ‚Ç¨</p>
          <p>
            Total r√©el compt√© des recettes en esp√®ces : {{
              (lastClosure.closingCashAmount ?? 0)|number_format(2, ',', ' ')
            }} ‚Ç¨
          </p>
          {% if lastClosure.discrepancy is defined and lastClosure.discrepancy == 0 %}
            <p>‚úÖ Pas d'erreur de caisse pour cette session.</p>
          {% elseif lastClosure.discrepancy is defined %}
            <p>
              ‚ö†Ô∏è √âcart {{ lastClosure.discrepancy > 0 ? 'positif' : 'n√©gatif' }} de {{
                lastClosure.discrepancy|abs|number_format(2, ',', ' ')
              }} ‚Ç¨
            </p>
            {% if lastClosure.note %}
              <p role="note">üìå Commentaire : {{ lastClosure.note }}</p>
            {% endif %}
          {% endif %}
        </div>
      </section>
    {% else %}
      <section class="card"><p class="alert">Aucune session de caisse trouv√©e</p></section>
    {% endif %}
  {% endif %}
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="{{ asset('js/cash-register.js') }}" type="module"></script>
{% endblock %}
